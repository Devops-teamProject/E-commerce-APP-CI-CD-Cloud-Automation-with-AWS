pipeline {
    agent any

    environment {
        AWS_REGION = 'us-east-1'
        TF_DIR = "/var/lib/jenkins/workspace/E-commerce-APP-CI-CD-Cloud-Automation-with-AWS/terraform/eks"
        K8S_DIRS = "k8s"
    }

    stages {

        stage('Remove Kubernetes Deployment') {
            steps {
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding',
                                  credentialsId: 'aws-creds']]) {

                    // Update kubeconfig
                    sh """
                        aws eks --region ${env.AWS_REGION} update-kubeconfig --name ecommerce-eks-cluster
                    """

                    echo ">>>>> Kubeconfig updated........."

                    // Delete frontend
                    dir("${env.K8S_DIRS}/frontend") {
                        sh 'kubectl delete -f . --ignore-not-found=true || true'
                    }

                    // Delete backend
                    dir("${env.K8S_DIRS}/backend") {
                        sh 'kubectl delete -f . --ignore-not-found=true || true'
                    }

                    // Delete database
                    dir("${env.K8S_DIRS}/database") {
                        sh 'kubectl delete -f . --ignore-not-found=true || true'
                    }

                    // Delete namespace
                    dir("${env.K8S_DIRS}/namespace") {
                        sh 'kubectl delete -f . --ignore-not-found=true || true'
                    }

                    echo ">>>>> Kubernetes resources removed successfully."
                }
            }
        }

        stage('Terraform Destroy') {
            steps {
                dir(env.TF_DIR) {
                    withCredentials([[$class: 'AmazonWebServicesCredentialsBinding',
                                      credentialsId: 'aws-creds']]) {
                        sh """
                            terraform init --upgrade
                            terraform destroy -auto-approve
                        """
                    }
                }

                echo ">>>>> Terraform infrastructure destroyed successfully."
            }
        }

    }
}



