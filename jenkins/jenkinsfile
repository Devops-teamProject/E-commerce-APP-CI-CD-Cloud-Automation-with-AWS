pipeline {
    agent any
    environment {
                AWS_REGION = 'us-east-1'                     // change if needed
                TAG        = "${env.BUILD_NUMBER ?: 'local'}"
                DOCKER_REPO_BACKEND  = "ahmeddaoud97/backend"
                DOCKER_REPO_FRONTEND = "ahmeddaoud97/frontend"
                TF_DIR = "terraform/eks"
                                         // base k8s folder; will apply subfolders
            }      

    stages{   


        stage('test stage'){
            steps{
                    echo ">>>>>  stage 'test stage' is commplete........."
                  }  }


        stage('Build & Push stage'){
            steps{
                    
                

                 withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                     sh """
                            echo \$PASS | docker login -u $USER --password-stdin
                            echo "Docker Login Successful"

                            echo "********************************"
                            echo "  Building Backend Image..."
                            echo "********************************"
                            docker build -t ${env.DOCKER_REPO_BACKEND}:${env.TAG} ./ecommerce-backend

                            echo "********************************"
                            echo "  Pushing Backend Image..."
                            echo "********************************"
                            docker push ${env.DOCKER_REPO_BACKEND}:${env.TAG} 

                            echo "********************************"
                            echo "    Building Frontend Image..."
                            echo "********************************"
                            docker build -t ${env.DOCKER_REPO_FRONTEND}:${env.TAG} ./ecommerce-frontend

                            echo "********************************"
                            echo "    Pushing Frontend Image..."
                            echo "********************************"
                            docker push ${env.DOCKER_REPO_FRONTEND}:${env.TAG}
                        """
                    } 

                echo ">>>>>  stage 'Build & Push stage' is commplete........."

                  }
                        } 

        stage('Terraform initialize EKS cluster'){
            steps{
                    dir(env.TF_DIR) {
                        withCredentials([[$class: 'AmazonWebServicesCredentialsBinding',
                        credentialsId: 'aws-creds']]) {
                            sh '''
                               terraform init --upgrade
                               
                               '''
                        }
                    }
                    echo ">>>>>  stage 'Terraform Initialize' is commplete........."
                  }  }

        stage('Terraform plan EKS cluster'){
            steps{
                    dir(env.TF_DIR) {
                        withCredentials([[$class: 'AmazonWebServicesCredentialsBinding',
                        credentialsId: 'aws-creds']]) {
                            sh '''
                               terraform plan -out=tfplan || true
                               '''
                        }
                    }
                    echo ">>>>>  stage 'Terraform Plan' is commplete........."
                  }  }
                  

        stage('Terraform apply EKS cluster'){
            steps{
                    dir(env.TF_DIR) {
                        withCredentials([[$class: 'AmazonWebServicesCredentialsBinding',
                        credentialsId: 'aws-creds']]) {
                            sh '''
                               terraform apply -auto-approve tfplan || true
                               '''
                        }
                    }
                    echo ">>>>>  stage 'Terraform Apply' is commplete........."
                  }  }


 

         stage('Deploy on EKS cluster'){
            steps{

                    withCredentials([[$class: 'AmazonWebServicesCredentialsBinding',
                    credentialsId: 'aws-creds']]) {
                    sh '''
                       aws eks --region us-east-1 update-kubeconfig --name ecommerce-eks-cluster
                       '''// update kubeconfig to interact with the EKS cluster
                    echo ">>>>>  kubeconfig updated to interact with the EKS cluster........."
                    dir("k8s/namespaces") {  // create namespaces
                                  sh '''
                                  kubectl apply -f .
                              '''
                              }
                    dir("k8s/database") {  // database deployment
                                  sh '''
                                  kubectl apply -f .
                              '''
                              }

                        dir("k8s/backend") {  // backend deployment    
                                  sh '''
                                  kubectl apply -f .
                              '''
                              }
                        dir("k8s/frontend") {  // frontend deployment
                                  sh '''
            
                                  kubectl apply -f .
                              '''
                              }
                        echo ">>>>>  stage 'Deploy' is commplete........." 

                     echo " the application is deployed successfully " 

                        echo " Access the application using the LoadBalancer IP of the frontend service : "

                        sh '''
                                  sleep 60  

                                  kubectl get ingress -n frontend

                                  sleep 300 


                        '''
                    }

              }
                   } 



        }

    }
